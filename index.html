<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوت تلجرام - خدمة أولياء الأمور</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- إضافة JotForm AI -->
    <script src='https://cdn.jotfor.ms/agent/embedjs/019932f8eeb67de397162a0d8c2d541451fe/embed.js'></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .service-content {
            max-height: 400px;
            overflow-y: auto;
        }
        .typing-dots {
            display: inline-flex;
            gap: 3px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        /* زر الرجوع المحسن */
        .back-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        .back-button:active {
            transform: translateY(0);
        }
        /* زر الرجوع العائم */
        .floating-back-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 14px 18px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 1000;
        }
        .floating-back-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }
        /* إخفاء واجهة JotForm الافتراضية */
        .jf-agent-widget {
            display: none !important;
        }
        .jf-agent-button {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <div class="flex items-center space-x-3 space-x-reverse">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <span class="text-blue-600 text-xl">🤖</span>
                </div>
                <div>
                    <h1 class="font-bold text-lg">بوت خدمة أولياء الأمور</h1>
                    <p class="text-blue-200 text-sm" id="connectionStatus">متصل الآن</p>
                </div>
            </div>
            <div class="text-blue-200">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- Service Content Container -->
    <div id="serviceContentContainer" class="max-w-md mx-auto bg-white hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-50 to-purple-50">
            <button onclick="backToServices()" class="back-button">
                <span>⬅</span>
                <span>العودة إلى الخدمات</span>
            </button>
            <h3 id="serviceTitle" class="font-bold text-gray-800 text-lg"></h3>
        </div>
        <div id="serviceContent" class="service-content p-4">
            <!-- Service content will be displayed here -->
        </div>
    </div>

    <!-- Floating Back Button -->
    <div id="floatingBackButton" class="fixed bottom-6 left-6 z-50 hidden">
        <button onclick="backToServices()" class="floating-back-button">
            <span>↶</span>
            <span>رجوع</span>
        </button>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="max-w-md mx-auto bg-white shadow-xl min-h-screen flex flex-col">
        <!-- Messages Area -->
        <div id="messagesArea" class="flex-1 p-4 space-y-4 overflow-y-auto">
            <!-- Welcome Message -->
            <div class="message-bubble">
                <div class="bg-gray-100 rounded-lg p-3">
                    <p class="text-gray-800">مرحباً بك في بوت خدمة أولياء الأمور! 👋</p>
                    <p class="text-gray-600 text-sm mt-1">أنا هنا لمساعدتك في متابعة شؤون الطلاب والتعرف على آخر المستجدات.</p>
                </div>
            </div>

            <div class="message-bubble">
                <div class="bg-blue-50 rounded-lg p-3">
                    <p class="text-blue-800 font-medium">الخدمات المتاحة:</p>
                    <p class="text-blue-600 text-sm mt-1">اختر الخدمة التي تريدها من القائمة أدناه</p>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="flex justify-center p-4 hidden">
            <div class="typing-indicator bg-blue-500 text-white rounded-lg p-3">
                <p>🔄 جاري تحميل البيانات...</p>
            </div>
        </div>

        <!-- Services Container -->
        <div id="servicesContainer" class="p-4">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectService('schedule')" class="bg-purple-500 hover:bg-purple-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    📅 الجدول الدراسي
                </button>
                <button onclick="selectService('homework')" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    📝 الواجبات
                </button>
                <button onclick="selectService('ai')" class="bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    🤖 الذكاء الاصطناعي
                </button>
                <button onclick="selectService('broadcast')" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    📢 البروكاست
                </button>
                <button onclick="selectService('programs')" class="bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    🏆 البرامج
                </button>
                <button onclick="selectService('files')" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    📁 الملفات
                </button>
                <button onclick="selectService('exams')" class="bg-pink-500 hover:bg-pink-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    📋 الاختبارات
                </button>
                <button onclick="selectService('contact')" class="bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-lg text-sm font-medium transition-colors active:scale-95">
                    📞 تواصل معنا
                </button>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t bg-gray-50 p-4">
            <div class="flex items-center space-x-2 space-x-reverse">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="اكتب رسالتك هنا..."
                    class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-blue-500"
                    onkeypress="handleKeyPress(event)"
                >
                <button 
                    onclick="sendMessage()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2 transition-colors"
                >
                    <svg class="w-5 h-5 transform rotate-180" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let botData = null;
        const API_URL = '/api/data';
        let jotformAIReady = false;
        
        // Initialize Telegram Web App
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // نظام مراقبة JotForm AI
        function initializeJotformAI() {
            console.log('🔍 جاري البحث عن JotForm AI...');
            
            const checkAI = setInterval(() => {
                if (window.JotformAgent) {
                    console.log('✅ تم العثور على JotformAgent');
                    jotformAIReady = true;
                    clearInterval(checkAI);
                    return;
                }
                
                const jotformObjects = Object.keys(window).filter(key => 
                    key.toLowerCase().includes('jotform') || 
                    key.toLowerCase().includes('agent')
                );
                
                if (jotformObjects.length > 0) {
                    console.log('✅ تم العثور على كائنات JotForm:', jotformObjects);
                    jotformAIReady = true;
                    clearInterval(checkAI);
                    return;
                }
            }, 1000);

            setTimeout(() => {
                clearInterval(checkAI);
                if (!jotformAIReady) {
                    console.log('❌ لم يتم العثور على JotForm AI');
                }
            }, 10000);
        }

        // بدء التهيئة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initializeJotformAI();
            loadData();
        });

        // Load data from server
        async function loadData() {
            showLoading(true);
            updateStatus('جاري الاتصال بالخادم...');
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error('فشل في جلب البيانات');
                }
                
                botData = await response.json();
                updateStatus('✅ متصل - البيانات محدثة');
                showLoading(false);
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('❌ خطأ في الاتصال');
                showLoading(false);
            }
        }

        async function selectService(service) {
            const serviceNames = {
                'schedule': 'الجدول الدراسي',
                'homework': 'الواجبات المنزلية', 
                'ai': 'ربوت الذكاء الاصطناعي',
                'broadcast': 'البروكاست',
                'programs': 'البرامج والمسابقات',
                'files': 'الملفات المرسلة',
                'exams': 'الاختبارات',
                'contact': 'تواصل معنا'
            };

            addMessage(`اخترت: ${serviceNames[service]}`, true);
            
            if (service === 'ai') {
                if (jotformAIReady) {
                    addMessage('🤖 **مساعد الذكاء الاصطناعي المتقدم**\n\nمرحباً! أنا مساعدك الذكي المدعوم بـ JotForm AI.\n\nيمكنني:\n• الإجابة على أسئلتك التعليمية بدقة عالية\n• شرح المفاهيم الصعبة بشكل مبسط\n• مساعدتك في حل الواجبات والتمارين\n• تقديم نصائح دراسية مخصصة\n• الإجابة على استفساراتك العامة\n\nما الذي تريد أن تسأل عنه؟', false);
                } else {
                    addMessage('🤖 **مساعد الذكاء الاصطناعي**\n\nمرحباً! جاري تهيئة نظام الذكاء الاصطناعي...\n\nيمكنك:\n• استخدام الخدمات الأخرى أثناء الانتظار\n• المحاولة مرة أخرى بعد قليل\n• إرسال رسالتك وسأحاول معالجتها\n\nما الذي تريد مساعدة فيه؟', false);
                }
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('فشل في جلب البيانات');
                
                const data = await response.json();
                const serviceData = data.services[service];
                
                showLoading(false);
                
                if (serviceData && serviceData.sections && serviceData.sections.length > 0) {
                    displayServiceContent(serviceData);
                } else {
                    useDefaultServiceResponse(service);
                }
                
            } catch (error) {
                showLoading(false);
                useDefaultServiceResponse(service);
            }
        }

        function displayServiceContent(serviceData) {
            document.getElementById('chatContainer').classList.add('hidden');
            document.getElementById('serviceContentContainer').classList.remove('hidden');
            document.getElementById('floatingBackButton').classList.remove('hidden');
            
            document.getElementById('serviceTitle').textContent = serviceData.name;
            
            let contentHtml = '';
            
            serviceData.sections.forEach(section => {
                contentHtml += `
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-800 text-lg mb-3 border-b pb-2">${section.name}</h4>
                `;
                
                if (section.description && section.description !== 'لا يوجد وصف') {
                    contentHtml += `<p class="text-gray-600 mb-4">${section.description}</p>`;
                }
                
                if (section.content && section.content.length > 0) {
                    section.content.forEach(item => {
                        if (item.type === 'text') {
                            contentHtml += `
                                <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                    <div class="flex items-start space-x-2 space-x-reverse">
                                        <span class="text-gray-500 mt-1">📄</span>
                                        <div>
                                            ${item.title ? `<h5 class="font-semibold text-gray-800 mb-2">${item.title}</h5>` : ''}
                                            <p class="text-gray-700 whitespace-pre-line">${item.content}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (item.type === 'file') {
                            contentHtml += `
                                <div class="bg-green-50 p-4 rounded-lg mb-3">
                                    <div class="flex items-start space-x-2 space-x-reverse">
                                        <span class="text-green-600 mt-1">📎</span>
                                        <div class="flex-1">
                                            <h5 class="font-semibold text-green-800 mb-1">${item.name}</h5>
                                            <p class="text-green-700 text-sm mb-2">${item.description || 'ملف مرفوع'}</p>
                                            ${item.fileUrl ? `
                                                <a href="${window.location.origin}${item.fileUrl}" 
                                                   target="_blank"
                                                   class="inline-block bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors">
                                                    📥 تحميل الملف
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (item.type === 'image') {
                            contentHtml += `
                                <div class="bg-yellow-50 p-4 rounded-lg mb-3">
                                    <div class="flex items-start space-x-2 space-x-reverse">
                                        <span class="text-yellow-600 mt-1">🖼️</span>
                                        <div class="flex-1">
                                            <h5 class="font-semibold text-yellow-800 mb-2">${item.title}</h5>
                                            ${item.fileUrl ? `
                                                <img src="${window.location.origin}${item.fileUrl}" 
                                                     alt="${item.description || 'صورة'}"
                                                     class="w-full max-w-md rounded-lg mb-2 border">
                                            ` : ''}
                                            <p class="text-yellow-700 text-sm mb-2">${item.description || 'صورة مرفوعة'}</p>
                                            ${item.fileUrl ? `
                                                <a href="${window.location.origin}${item.fileUrl}" 
                                                   target="_blank"
                                                   class="inline-block bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition-colors">
                                                    👁️ عرض الصورة
                                                </a>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (item.type === 'link') {
                            contentHtml += `
                                <div class="bg-purple-50 p-4 rounded-lg mb-3">
                                    <div class="flex items-start space-x-2 space-x-reverse">
                                        <span class="text-purple-600 mt-1">🔗</span>
                                        <div class="flex-1">
                                            <h5 class="font-semibold text-purple-800 mb-1">${item.title}</h5>
                                            <p class="text-purple-700 text-sm mb-2">${item.description || 'رابط خارجي'}</p>
                                            <a href="${item.url}" 
                                               target="_blank"
                                               class="inline-block bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors">
                                                🌐 زيارة الرابط
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                } else {
                    contentHtml += `
                        <div class="text-center py-4 bg-gray-50 rounded-lg">
                            <p class="text-gray-500">لا يوجد محتوى في هذا القسم</p>
                        </div>
                    `;
                }
                
                contentHtml += `</div>`;
            });

            document.getElementById('serviceContent').innerHTML = contentHtml;
        }

        function backToServices() {
            document.getElementById('serviceContentContainer').classList.add('hidden');
            document.getElementById('floatingBackButton').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
        }

        function useDefaultServiceResponse(service) {
            const defaultResponses = {
                'schedule': '📅 **الجدول الدراسي**\n\nإليك الجدول الدراسي لهذا الأسبوع:\n\n📚 الأحد: رياضيات، عربي، علوم\n📚 الاثنين: إنجليزي، تاريخ، رياضة\n📚 الثلاثاء: علوم، جغرافيا، فنون\n📚 الأربعاء: رياضيات، إنجليزي، تربية إسلامية\n📚 الخميس: علوم، عربي، أنشطة',
                'homework': '📝 **الواجبات المنزلية**\n\nالواجبات المطلوبة:\n\n📝 رياضيات: حل التمارين ص 45-47\n📝 العربي: كتابة موضوع تعبير\n📝 العلوم: قراءة الفصل الثالث\n📝 الإنجليزي: حفظ المفردات الجديدة\n\n📅 موعد التسليم: غداً',
                'broadcast': '📢 **الإعلانات والبروكاست**\n\nآخر الإعلانات والأخبار:\n\n🔔 تذكير: اختبار الرياضيات يوم الأربعاء\n🔔 إجازة نصف العام تبدأ 15 فبراير\n🔔 اجتماع أولياء الأمور يوم الخميس\n🔔 تم تأجيل رحلة الصف السادس\n\n📅 آخر تحديث: اليوم 2:30 م',
                'programs': '🏆 **البرامج والمسابقات**\n\nالبرامج والمسابقات الحالية:\n\n🎯 مسابقة القرآن الكريم - التسجيل مفتوح\n🎯 برنامج المواهب الطلابية - 20 فبراير\n🎯 مسابقة الرياضيات - المرحلة النهائية\n🎯 معرض العلوم السنوي - مارس 2024',
                'files': '📁 **الملفات المرسلة**\n\nالملفات المتاحة للتحميل:\n\n📄 جدول الاختبارات النهائية.pdf\n📄 قائمة الكتب المطلوبة.pdf\n📄 نموذج طلب إجازة.pdf\n📄 دليل ولي الأمر.pdf\n📄 التقويم الدراسي 2024.pdf',
                'exams': '📋 **الاختبارات**\n\nجدول الاختبارات القادمة:\n\n📝 الرياضيات: الأربعاء 10 فبراير - 8:00 ص\n📝 اللغة العربية: الخميس 11 فبراير - 8:00 ص\n📝 العلوم: الأحد 14 فبراير - 8:00 ص\n📝 الإنجليزي: الاثنين 15 فبراير - 8:00 ص\n\n⏰ مدة كل اختبار: ساعتان',
                'contact': '📞 **تواصل معنا**\n\nمعلومات التواصل:\n\n📱 الهاتف: 011-234-5678\n📧 البريد: info@school.edu.sa\n🌐 الموقع: www.school.edu.sa\n📍 العنوان: شارع التعليم، الرياض\n\n🕐 ساعات العمل:\nالأحد - الخميس: 7:00 ص - 2:00 م'
            };
            
            addMessage(defaultResponses[service] || 'الخدمة غير متاحة حالياً', false);
        }

        // التواصل مع JotForm AI
        async function getJotformAIResponse(userMessage) {
            if (!jotformAIReady) {
                return generateSmartResponse(userMessage);
            }
            
            try {
                let response;
                
                if (window.JotformAgent && window.JotformAgent.sendMessage) {
                    response = await window.JotformAgent.sendMessage(userMessage);
                }
                else if (window.JotformAgent && window.JotformAgent.chat) {
                    response = await window.JotformAgent.chat(userMessage);
                }
                else {
                    const aiObjects = Object.keys(window).filter(key => 
                        key.toLowerCase().includes('jotform') || 
                        key.toLowerCase().includes('agent')
                    );
                    
                    for (const objName of aiObjects) {
                        const obj = window[objName];
                        if (obj && typeof obj.sendMessage === 'function') {
                            response = await obj.sendMessage(userMessage);
                            break;
                        }
                        if (obj && typeof obj.chat === 'function') {
                            response = await obj.chat(userMessage);
                            break;
                        }
                    }
                }
                
                if (response) {
                    return response;
                } else {
                    throw new Error('لم يتم العثور على وظيفة الرد');
                }
                
            } catch (error) {
                console.error('JotForm AI Error:', error);
                return generateSmartResponse(userMessage);
            }
        }

        // رد ذكي احتياطي
        function generateSmartResponse(userMessage) {
            const message = userMessage.toLowerCase().trim();
            
            if (message.includes('شكر') || message.includes('thank')) {
                return 'العفو! 😊 سعيد لأنني استطعت مساعدتك. هل هناك شيء آخر تريد الاستفسار عنه؟';
            }
            
            if (message.includes('مرحب') || message.includes('hello') || message.includes('hi') || message.includes('السلام')) {
                return 'وعليكم السلام ورحمة الله وبركاته! 🌟\n\nمرحباً بك! أنا مساعدك الذكي في بوت المدرسة. كيف يمكنني مساعدتك اليوم؟';
            }
            
            if (message.includes('مساعدة') || message.includes('help') || message.includes('مساعده')) {
                return `🎯 **كيف يمكنني مساعدتك؟**

🤖 **المساعد الذكي:**
• الإجابة على استفساراتك المدرسية
• توجيهك للخدمات المناسبة
• مساعدتك في المواضيع التعليمية

📚 **الخدمات المتاحة:**
• الجدول الدراسي 📅
• الواجبات المنزلية 📝
• الاختبارات 📋
• الملفات المهمة 📁
• البرامج والمسابقات 🏆

ما هو نوع المساعدة الذي تبحث عنه؟`;
            }
            
            return `🤖 **المساعد الذكي**

شكراً على سؤالك! 🔍

للحصول على أفضل مساعدة، يمكنك:

• **استخدام الخدمات المتخصصة** في الأعلى للمعلومات المؤكدة
• **توضيح سؤالك أكثر** لأتمكن من مساعدتك بشكل أفضل
• **الاستفسار عن موضوع محدد** مثل جدول الحصص أو الواجبات

ما هو استفسارك بالتحديد؟`;
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
        }

        function updateStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function addMessage(text, isUser) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble';
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="flex justify-end">
                        <div class="bg-blue-500 text-white rounded-lg p-3 max-w-xs">
                            <p>${text}</p>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex justify-start">
                        <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                            <p class="text-gray-800 whitespace-pre-line">${text}</p>
                        </div>
                    </div>
                `;
            }
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesArea = document.getElementById('messagesArea');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message-bubble';
            typingDiv.innerHTML = `
                <div class="flex justify-start">
                    <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span class="text-gray-500 text-sm">جاري المعالجة...</span>
                        </div>
                    </div>
                </div>
            `;
            messagesArea.appendChild(typingDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, true);
                input.value = '';
                
                showTypingIndicator();
                
                setTimeout(async () => {
                    try {
                        const aiResponse = await getJotformAIResponse(message);
                        hideTypingIndicator();
                        addMessage(aiResponse, false);
                    } catch (error) {
                        hideTypingIndicator();
                        addMessage('عذراً، حدث خطأ في المعالجة. حاول مرة أخرى.', false);
                    }
                }, 1500);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>
